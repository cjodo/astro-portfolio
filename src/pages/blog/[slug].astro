---
const { slug } = Astro.params 
import BlogLayout from "../../layouts/BlogLayout.astro"
import { db, BlogPosts, eq } from "astro:db";
import { Markdown } from "astro-remote";
import Breadcrumb from "@/components/Breadcrumb.astro";

import Title from "@/components/Markdown/Title.astro"
import { getPost } from "@/lib/posts";

export const prerender = false

const postNotFound = () => {
	return new Response(null, {
		status: 404,
		statusText: "Post not found"
	})
}

if(!slug) {
	return postNotFound();
}

const post = await db.select().from(BlogPosts).where(eq(BlogPosts.slug, slug))


if(post.length === 0 || !post[0].published) {
	return postNotFound();
}

const postData = post[0];
console.log(postData)

let content = postData.content

if(postData.contentRef) {
	const ref = postData.contentRef
	console.log(ref)
	content = await getPost(ref)
}
---

<BlogLayout>
	<article class="max-w-4xl mx-auto px-4 py-8">
		<Breadcrumb items={[
			{ name: "Blog", href: "/blog" },
			{ name: postData.title }
		]} />
		<header class="mb-8">
			<h1 class="text-4xl font-bold mb-4">{postData.title}</h1>
			<div class="text-gray-600 text-sm">
				<time datetime={postData.date.toISOString()}>
					{postData.date.toLocaleDateString()}
				</time>
				<span class="mx-2">â€¢</span>
				<span>{postData.readTime} min read</span>
			</div>
		</header>
		
		<div class="prose prose-lg max-w-none">
			<Markdown content={content} components={{ h1: Title }} />
		</div>
	</article>
</BlogLayout>
