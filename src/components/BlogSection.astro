---
import { db, BlogPosts, Tags, PostTags, eq, and } from 'astro:db';

export interface Props {
  selectedTag?: string;
  selectedCategory?: string;
}

const { selectedTag, selectedCategory } = Astro.props;

// Get all posts with their tags
const posts = await db.select()
  .from(BlogPosts)
  .where(eq(BlogPosts.published, true))
  .orderBy(BlogPosts.date);

// Get all tags
const allTagsDb = await db.select().from(Tags);

// Filter posts based on selected tag
const filteredPosts = [];
for (const post of posts) {
  const postTags = await db.select()
    .from(PostTags)
    .where(eq(PostTags.postId, post.id));
  
  const tagIds = postTags.map(pt => pt.tagId);
  const tags = allTagsDb.filter(tag => tagIds.includes(tag.id));
  
  const tagMatch = !selectedTag || tagIds.includes(selectedTag);
  
  if (tagMatch) {
    filteredPosts.push({
      ...post,
      tags: tags.map(tag => tag.name),
    });
  }
}

// Get all unique tag names for filter
const allTags = allTagsDb.map(tag => tag.name);
const allCategories = ['Tutorial', 'CSS', 'Web Development']; // Can be enhanced later

// Format date
const formatDate = (date: Date) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};
---

<section class="blog-section">
  <header class="blog-header">
    <h1 class="blog-title">Blog</h1>
    <p class="blog-subtitle">Thoughts, tutorials, and insights</p>
  </header>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <label for="category-filter" class="filter-label">Category:</label>
      <select id="category-filter" class="filter-select">
        <option value="">All Categories</option>
        {allCategories.map(category => (
          <option value={category} selected={selectedCategory === category}>
            {category}
          </option>
        ))}
      </select>
    </div>

    <div class="filter-group">
      <label for="tag-filter" class="filter-label">Tag:</label>
      <select id="tag-filter" class="filter-select">
        <option value="">All Tags</option>
        {allTags.map(tag => (
          <option value={tag} selected={selectedTag === tag}>
            {tag}
          </option>
        ))}
      </select>
    </div>
  </div>

  <!-- Posts Grid -->
  <div class="posts-grid">
    {filteredPosts.length > 0 ? (
      filteredPosts.map((post) => (
        <article class="">
          <div class="">
            <div class="">
              <time datetime={post.date.toISOString()} class="post-date">
                {formatDate(post.date)}
              </time>
              <span class="post-read-time">{post.readTime} min read</span>
            </div>
            
            <h2 class="post-title">
              <a href={`/blog/${post.slug}`} class="post-link">
                {post.title}
              </a>
            </h2>
            
            <p class="">{post.excerpt}</p>
            
            <div class="post-footer">
              <div class="post-tags">
                {post.tags.map(tag => (
                  <span class="post-tag">{tag}</span>
                ))}
              </div>
            </div>
          </div>
        </article>
      ))
    ) : (
      <div class="no-posts">
        <p>No posts found matching your filters.</p>
      </div>
    )}
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
    const tagFilter = document.getElementById('tag-filter') as HTMLSelectElement;
    
    const updateFilters = () => {
      const category = categoryFilter.value;
      const tag = tagFilter.value;
      
      const params = new URLSearchParams();
      if (category) params.set('category', category);
      if (tag) params.set('tag', tag);
      
      const newUrl = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
      window.history.replaceState({}, '', newUrl);
      
      // Trigger a page reload to apply filters
      window.location.reload();
    };
    
    categoryFilter.addEventListener('change', updateFilters);
    tagFilter.addEventListener('change', updateFilters);
  });
</script>
