---
import SkillCard from './SkillCard.astro';
import type { Skill, SkillCategory } from '../../data/skills';
import { skillsByCategory, categoryLabels } from '../../data/skills';
import { getAnimationDelay } from '../../utils/animations';

const { skills, showProficiency = true, compact = false } = Astro.props

interface Props {
	skills: Skill[]
	showProficiency?: boolean
	compact?: boolean
}

// For compact view, we'll use JavaScript to limit initial display
const displaySkills = skills;
---

<!-- Skills Section for About Me -->
<div class="skills-section">
  <!-- Filter and Sort Controls -->
  <div class="skills-controls mb-6">
    <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
      <!-- Proficiency Filter -->
      <div class="flex flex-wrap gap-2 items-center">
        <span class="text-sm font-medium text-gray-700">Filter by level:</span>
        <div class="flex gap-2" id="about-proficiency-filters">
          <button 
            data-proficiency="all" 
            class="proficiency-filter px-3 py-1 text-xs rounded-full bg-gray-800 text-white hover:bg-gray-700 transition-colors font-medium"
            aria-label="Show all skills"
          >
            All
          </button>
          <button
            data-proficiency="beginner"
            class="proficiency-filter px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors font-medium"
            aria-label="Show beginner skills"
          >
            Beginner
          </button>
          <button
            data-proficiency="intermediate"
            class="proficiency-filter px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors font-medium"
            aria-label="Show intermediate skills"
          >
            Intermediate
          </button>
          <button
            data-proficiency="advanced"
            class="proficiency-filter px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors font-medium"
            aria-label="Show advanced skills"
          >
            Advanced
          </button>
          <button
            data-proficiency="expert"
            class="proficiency-filter px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors font-medium"
            aria-label="Show expert skills"
          >
            Expert
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Skills Grid -->
  <div id="about-skills-container" class="relative">
    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 md:gap-4 skills-grid">
      {displaySkills.map((skill, i) => (
        <div
          data-animate
          class="animate-scale-in animate-stagger skill-item"
          data-skill-name={skill.name}
          data-proficiency={skill.proficiency || 'none'}
          data-category={skill.category}
          style={`--delay: ${getAnimationDelay(i)}`}
        >
          <SkillCard skill={skill} showProficiency={showProficiency} />
        </div>
      ))}
    </div>
  </div>

  <!-- Show More Button for Compact View -->
  {compact && skills.length > 12 && (
    <div class="mt-6 text-center">
      <button 
        id="show-more-skills"
        class="px-4 py-2 text-sm bg-gray-800 text-white rounded-md hover:bg-gray-700 transition-colors font-medium"
        aria-label="Show all skills"
      >
        Show All Skills ({skills.length})
      </button>
    </div>
  )}
</div>

<script is:inline>
  // Simple skills manager without external dependencies
  document.addEventListener('DOMContentLoaded', function() {
    class AboutSkillsManager {
    constructor() {
      this.currentProficiency = 'all';
      this.allSkills = [];
      this.compact = false;
      this.expanded = false;
      this.init();
    }

      init() {
        // Wait a bit for everything to render
        setTimeout(() => {
          const proficiencyFilters = document.querySelectorAll('#about-proficiency-filters .proficiency-filter');
          const showMoreBtn = document.getElementById('show-more-skills');
          
          this.compact = showMoreBtn !== null;
          this.allSkills = Array.from(document.querySelectorAll('.skill-item'));
          
          console.log('Found', this.allSkills.length, 'skill items');
          
          // Set initial state - show all skills by default
          // For compact view, only show first 12 initially
          this.allSkills.forEach((item, index) => {
            if (this.compact && index >= 12) {
              item.style.display = 'none';
            } else {
              item.style.display = '';
              // Add show class to make animations visible
              item.classList.add('show');
            }
          });
          
          if (proficiencyFilters.length > 0) {
            proficiencyFilters.forEach(button => {
              button.addEventListener('click', (e) => {
                this.handleProficiencyFilter(e.target.dataset.proficiency);
              });
            });
          }

          if (showMoreBtn) {
            showMoreBtn.addEventListener('click', () => {
              this.showAllSkills();
            });
          }
        }, 100);
      }

      handleProficiencyFilter(proficiency) {
        this.currentProficiency = proficiency;
        this.updateActiveFilterButton(proficiency);
        this.applyFilters();
      }

      updateActiveFilterButton(activeProficiency) {
        const buttons = document.querySelectorAll('#about-proficiency-filters .proficiency-filter');
        buttons.forEach(button => {
          const buttonProficiency = button.dataset.proficiency;
          if (buttonProficiency === activeProficiency) {
            button.className = 'proficiency-filter px-3 py-1 text-xs rounded-full bg-gray-800 text-white hover:bg-gray-700 transition-colors font-medium';
          } else {
            button.className = 'proficiency-filter px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors font-medium';
          }
        });
      }

    applyFilters() {
      // In compact mode, we consider only first 12 skills unless expanded
      const availableSkills = this.compact && !this.expanded ? 
        this.allSkills.slice(0, 12) : 
        this.allSkills;

      // Filter by proficiency
      const filteredItems = availableSkills.filter(item => {
        if (this.currentProficiency === 'all') return true;
        return item.dataset.proficiency === this.currentProficiency;
      });

      // Hide all items first
      this.allSkills.forEach(item => {
        item.style.display = 'none';
      });

      // Show filtered items (no sorting, maintain original order)
      filteredItems.forEach((item) => {
        item.style.display = '';
        // Add show class to make animations visible
        item.classList.add('show');
      });
    }

    showAllSkills() {
      const showMoreBtn = document.getElementById('show-more-skills');
      if (showMoreBtn) {
        showMoreBtn.style.display = 'none';
      }
      
      // Mark as expanded so applyFilters knows to use all skills
      this.expanded = true;
      
      // Reapply filters with all skills available
      this.applyFilters();
    }

      
    }

    // Initialize the skills manager
    new AboutSkillsManager();
  });
</script>